# CheckRolesRPA - Чекер ролей Discord

Универсальный софт-чекер ролей для Discord с точечной настройкой через Google таблицы и интеграцией с ADSpower API.

## Возможности

- ✅ Работа с профилями ADSpower через `serial_number`
- ✅ Использование **patchright** (undetected Playwright) для обхода детекции
- ✅ Настройка через Google таблицы (названия листов настраиваются в config.yaml)
- ✅ Автоматическая авторизация в Discord
- ✅ Проверка полной загрузки страниц перед выполнением действий
- ✅ Проверка username и переавторизация при необходимости
- ✅ Поиск пользователей на серверах Discord
- ✅ Сбор ролей пользователей
- ✅ Сохранение результатов в Google таблицу
- ✅ **Многопоточный режим** - параллельная обработка нескольких серверов (настраивается в config.yaml)

## Структура Google таблицы

### Лист `ds_data` (название настраивается в config.py)
Страница для данных профиля через которого будет проходить отработка.

**Столбцы (первая строка - заголовки):**
- `serial_number` - серийный номер профиля ADSpower
- `email` - email для авторизации в Discord
- `password` - пароль для авторизации в Discord
- `username` - ожидаемый username в Discord (опционально, для проверки)

**Пример:**
| serial_number | email | password | username |
|---------------|-------|----------|----------|
| 1234567890 | user@example.com | password123 | username#1234 |

**Примечание:** Название листа по умолчанию `ds_data`, но можно изменить в `config.yaml` или через переменную окружения `GOOGLE_SHEET_DS_DATA`.

### Лист `ds_link` (название настраивается в config.yaml)
Страница для указания ссылок на Discord каналы/серверы.

**Столбцы (первая строка - заголовки):**
- `link` - ссылка на Discord сервер (например: `https://discord.com/channels/XXXXXXX`)

**Пример:**
| link |
|------|
| https://discord.com/channels/123456789012345678 |
| https://discord.com/channels/987654321098765432 |

**Примечание:** Название листа по умолчанию `ds_link`, но можно изменить в `config.yaml` или через переменную окружения `GOOGLE_SHEET_DS_LINK`.

### Лист `чек-отработка` (название настраивается в config.yaml)
Страница для заполнения профилями для чекера и записи результатов.

**Столбцы (первая строка - заголовки, входные данные):**
- `username` - username пользователя для проверки (обязательно)
- `serial_number` - (опционально) серийный номер профиля

**Столбцы (результаты, добавляются автоматически):**
- `username` - проверенный username
- `serial_number` - серийный номер профиля
- `found` - найден ли пользователь (True/False)
- `roles` - список ролей через запятую
- `timestamp` - время проверки (формат: YYYY-MM-DD HH:MM:SS)
- `error` - ошибка (если была)

**Пример входных данных:**
| username | serial_number |
|----------|---------------|
| user1#1234 | |
| user2#5678 | |
| @user3 | |

**Пример результатов (добавляются автоматически):**
| username | serial_number | found | roles | timestamp | error |
|----------|---------------|-------|-------|-----------|-------|
| user1#1234 | | True | Admin, Moderator | 2024-01-15 10:30:00 | |
| user2#5678 | | False | Нет ролей | 2024-01-15 10:30:05 | |

**Примечание:** Название листа по умолчанию `чек-отработка`, но можно изменить в `config.yaml` или через переменную окружения `GOOGLE_SHEET_CHECK`.

## Установка

1. Клонируйте репозиторий или скачайте файлы

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

**Примечание:** Проект использует [patchright](https://github.com/Kaliiiiiiiiii-Vinyzu/patchright) - undetected версию Playwright для обхода детекции автоматизации.

3. Настройте Google Sheets API:
   - Создайте проект в [Google Cloud Console](https://console.cloud.google.com/)
   - Включите Google Sheets API
   - Создайте Service Account
   - Скачайте JSON файл с credentials
   - Сохраните его как `credentials.json` в корне проекта
   - Поделитесь Google таблицей с email из Service Account

4. Настройте конфигурацию:
   
   **Вариант 1: YAML файл (рекомендуется)**
   ```bash
   # Скопируйте пример конфигурации
   cp config.example.yaml config.yaml
   # Отредактируйте config.yaml и укажите свои настройки
   ```
   
   **Вариант 2: Переменные окружения**
   ```bash
   # Windows PowerShell
   $env:GOOGLE_SHEETS_ID="your_spreadsheet_id"
   $env:ADSPOWER_API_URL="http://local.adspower.net:50325"
   $env:ADSPOWER_API_KEY="your_api_key"  # Опционально, для локального API обычно не требуется
   $env:LOG_LEVEL="INFO"
   
   # Настройка названий листов Google Sheets (опционально)
   $env:GOOGLE_SHEET_DS_DATA="ds_data"
   $env:GOOGLE_SHEET_DS_LINK="ds_link"
   $env:GOOGLE_SHEET_CHECK="чек-отработка"
   ```
   
   **Приоритет настроек:**
   1. Переменные окружения (имеют наивысший приоритет)
   2. Значения из `config.yaml`
   3. Значения по умолчанию

## Использование

1. Подготовьте Google таблицу с необходимыми листами и данными

2. Запустите скрипт:
```bash
python main.py
```

## Логика работы

1. **Инициализация:**
   - Подключение к Google Sheets
   - Подключение к ADSpower API
   - Инициализация менеджера потоков (если включен многопоточный режим)

2. **Получение профиля(ей) для работы:**
   - **Однопоточный режим:** Чтение первого профиля из листа `ds_data`
   - **Многопоточный режим:** Чтение всех валидных профилей из листа `ds_data`
   - Получение `serial_number`, `email`, `password`, `username`

3. **Авторизация:**
   - Открытие браузера через ADSpower по `serial_number`
   - Переход на Discord
   - Проверка авторизации
   - При необходимости - авторизация по email/password
   - Проверка соответствия username

4. **Проверка ролей:**
   - Получение ссылок на серверы из листа `ds_link`
   - Получение списка username для проверки из листа `чек-отработка`
   - **Однопоточный режим:**
     - Для каждого сервера последовательно:
       - Переход на сервер
       - Для каждого username:
         - Поиск пользователя
         - Получение списка ролей
         - Сохранение результата в таблицу
   - **Многопоточный режим:**
     - Распределение серверов между потоками
     - Каждый поток работает со своим профилем и браузером
     - Параллельная обработка серверов
     - Потокобезопасное сохранение результатов в таблицу

## Требования

- Python 3.8+
- Google Chrome (для работы через ADSpower браузер не требуется отдельный ChromeDriver)
- ADSpower установлен и запущен
- Доступ к Google Sheets API
- Интернет-соединение
- Google таблица с настроенными листами (названия настраиваются в `config.py`)

## Особенности реализации

- **patchright**: Используется undetected версия Playwright для обхода детекции автоматизации
- **Антидетект Discord**: Комплексная система антидетекта для скрытия факта автоматизации:
  - Случайные задержки между действиями (имитация человеческого поведения)
  - Имитация человеческого ввода текста (с паузами между символами)
  - Случайные движения мыши и скроллинг
  - JavaScript патчи для скрытия признаков автоматизации (webdriver флаг, navigator свойства)
  - Реалистичные User-Agent и разрешения экрана
  - Имитация человеческих паттернов поведения
- **Улучшенный сбор ролей**: Использует проверенные методы из старого софта:
  - Поиск в списке участников с умным скроллингом (без взаимодействия с чатом)
  - Использование MutationObserver для ожидания элементов
  - Автоматическое нажатие "View All Roles" для показа всех ролей
  - Точные селекторы для сбора ролей из модального окна профиля
  - Улучшенная проверка авторизации через путь и наличие элементов
  - **Важно**: Не пишет и не взаимодействует с чатом каналов
- **Проверка загрузки страниц**: Все действия выполняются только после полной загрузки страницы (DOM, ресурсы, networkidle)
- **Настраиваемые листы**: Названия листов Google Sheets можно настроить в `config.yaml` или через переменные окружения
- **YAML конфигурация**: Все настройки хранятся в удобном YAML формате
- **ADSpower API**: API ключ опционален для локального API (обычно не требуется)

## Примечания

- Убедитесь, что ADSpower запущен и доступен по указанному адресу
- **API ключ ADSpower опционален** для локального API (обычно не требуется)
- Google таблица должна быть доступна для Service Account
- Названия листов Google Sheets можно настроить в `config.yaml` или через переменные окружения
- Создайте файл `config.yaml` на основе `config.example.yaml` перед первым запуском
- Discord может требовать капчу при частых запросах
- Рекомендуется использовать задержки между запросами
- Проект использует **patchright** для обхода детекции автоматизации
- **Антидетект система** автоматически применяет техники для скрытия автоматизации
- Все действия выполняются только после полной загрузки страницы (DOM, ресурсы, networkidle)

## Логирование

Логи сохраняются в файл `checker.log` и выводятся в консоль.

Уровни логирования:
- `DEBUG` - детальная информация
- `INFO` - общая информация
- `WARNING` - предупреждения
- `ERROR` - ошибки

## Поддержка

При возникновении проблем проверьте:
1. Логи в файле `checker.log`
2. Настройки в `config.py`
3. Доступность ADSpower API
4. Корректность данных в Google таблице
5. Доступность Discord серверов

